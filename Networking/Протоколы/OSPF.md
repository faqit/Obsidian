#Networking #Protocols 
## OSPF как протокол

**Open Shortest Path First** - Протокол выбора кратчайшего пути, представляет собой Link-State протокол, используемый в сетях, для создания простейшей динамической маршрутизации. Относится к семейству IGP (Interior Gateway Protocol) - условно внутренним протоколам.

В отличие от **Distance-Vector Protocols,** таких как EIGRP, которые сообщают "соседу" о своих сетях, но не говорят о внутреннем устройстве, из-за чего, в теории, могут возникнуть петли.
![[Distance Vector Protocols]]

то **Link-State** протоколы сообщают всем о своих Connected-сетях. Т.е. это своего рода full-view, но внутри сети. Благодаря подобному понимаю устройства сети, маршрутизаторы строят кратчайший путь до нужного им узла.
![[Link-State protocols]]

## Принцип работы OSPF

 Взаимодействие узлов OSPF происходит при помощи LSA-пакетов, которые хранят в себе информацию о изменениях в сети.
![[Принцип обмена LSA]]

**LSA** - это служебные пакеты, которые используются в OSPF для анонсирования информации о топологии сети.
LSA распространяются внутри LSU-пакета, который может содержать в себе несколько LSA.
Есть несколько типов LSA:
1. LSA type1 - OSPF Router LSA: 
   Этот типа пакетов отправляется между маршрутизаторами в пределах одной зоны, где были созданы и не покидают эту зону. С помощью LSAt1 каждый маршрутизатор сообщается свой уникальный router-id и список интерфейсов. Для каждого из интерфейсов указывается IP-адрес, Тип интерфейса, router-id, получаемый с этого интерфейса от другого OSPF-соседа. Если такого соседа нет, то указывается маска сети для IP-адреса и эта сторона считается "плоской".
2. LSA type2 - OSPF Network LSA:
   Генерируется DR для описания всех роутеров, подключенных к его сегменту напрямую. Это помогает формировать карту сети при помощи LSAt1 и отсылает пакет LSAt2 с указанием себя как advertise-роутера. LSAt2 рассылаются между соседями в одной зоне и остаются в пределах этой зоны.
3. LSA type3 - OSPF Summary LSA: 
   Генерируются ABR и содержат суммарное сообщение о подключенной к ним зоне и сообщают информацию в другие зоны, к которым подключен ABR. LSAt3 рассылаются в несколько зон и содержат в себе маршрутную информацию из разных зон.
4. LSA type4 - OSPF ASBR Summary LSA: 
   Это пакеты, сообщающие и наличии ASBR в других областях.
5. LSA type5 - OSPF ASBR External LSA: 
   Генерируются ASBR для передачи внешних редистрибуцированных маршрутов в OSPF. Типичный пример - default gateway. Данный LSA находится в рамках одной зоны.
6. LSA type6 - OSPF Group Membership LSA: 
   Созданы для mOSPF протокола, который поддерживает многоадресную маршрутизацию через OSPF. Не пользуется популярностью, т.к. вендоры для роутеров не завезли возможность пользоваться.
7. LSA type7 - OSPF not so Stubby Area (NSSA) External LSA: 
   Используются для некоторых зон, которые не позволяют внешним маршрутам проходить через них. Эти зоны блокируют распространение LSAt5. По сути LSAt7 это полный  аналог LSAt5 для NSSA area. Когда пересекает границы area - превращается в пакет LSAt5
8. LSA type8 - OSPF External Attributes LSA / Link Local LSA: 
   Пакеты LSAt8 в OSPFv2 называются внешними атрибутами LSA и используются для передачи атрибутов BGP через OSPF. В то время как адреса BGP передаются через LSAt5. Для OSPFv3 LSAt8 переопределяется для передачи информации IPv6.
9. LSA type9 - OSPF Link Score Opaque / Intra Area Prefix LSA: 
   В ipv4 определяется как Link Scope Opaque LSA для передачи информации в OSPF. для ipv6 переопределяется для обработки префикса связи для специального типа зоны - Stub
10. LSA type10 - OSPF Area Scope Opaque LSA:
    Используются для потоковой передачи информации OSPF через маршрутизаторы других областей. Используется для объявления MPLS и других протоколов.
11. LSA type11 - OSPF As Scope Opaque LSA:
   Выполняют ту же задачу, что и LSAt10, но не пересылаются в stub.
12. LSA type 9-11 Вкратце:
    Используются для расширения возможностей OSPF. На практике применяют в Traffic Engineering'e MPLS, где с помощью данных LSA передаются параметры интерфейса, такие как brandwidth, незанятая полоса пропускания и т.п.

Сам по себе OSPF разделяется на "Регионы" - Area. Нужно это для решения большой нагрузки на роутер, возникающей при расчете маршрутов внутри сети.

Разделение регионов помогает проще распределять маршруты - внутри каждой из зон маршруты просчитываются "честно", т.е. полноценно, после чего роутер, находящийся на стыке двух регионов отправляет маршрутную информацию из региона в регион уже просчитанную, т.е. роутер1 из area0 не просчитывает все маршруты до area1 - он знает, что маршруты area1 находятся за роутером2, который называется ABR.

Стадии установления OSPF-соседства

**Настройка OSPF происходит следующим образом:**
1. На нескольких узлах создается процесс OSPF N, где N - общее два двух устройств число
2. Опционально, настраиваются кастомные интервалы (Hello, dead, holdtime), которые должны совпадать на всех OSPF-соседях. Обычно в рамках одной зоны.
3. Настраивается редистрибьюция маршрутов (обычно connected), или статические анонсы сетей в рамках OSPF-зоны.
4. Опционально, при редистрибьюции настраиваются route-map, для ограничения или изменения маршрутной информации


## Особенности

1. Все регионы должны смотреть в регион 0 - Area 0 , это правило существует, чтобы обеспечить защиту от петель и избежать двойственности маршрутов.
2. ABR работает не как Link-State, а как Distance Vector, т.к. не просчитываются все маршруты между регионами.
3. Для установления полноценного соседства OSPF. требуется, чтобы участвующие узлы анонсировали одну и ту же сеть.

## Наименования

1. Area - Регион, зона OSPF.
2. DR -  Designated Router, Назначенный роутер, т.е. устройство, которое является "главным" внутри одной зоны OSPF.
3. BDR - Backup Designated Router, запасной назначенный роутер, .т.е. устройство, которое возьмет на себя "главенство", в случае ошибок с нынешним DR.
4. ABR - Area Border Router, пограничный маршрутизатор, т.е. устройство, находящееся между двух зон OSPF.
5. ASBR - Autonomous System Border Router, пограничный с другой автономной системой маршрутизатор, т.е. устройство, которое находится одной частью в OSPF, другой либо в BGP, либо в любом другом маршрутном пространстве.
6. IR - Internal Router, обычный роутер внутри зоны OSPF.
7. Backbone - "Позвоночный", .т.е. магистральный маршрутизатор, находящийся всеми интерфейсами внутри зоны Area 0.
8. LSDB - Link State Database - список всех записей о состоянии каналов.
9. LSA - Link State Advertisement - Оповещение состояния каналов
## Плюсы

1. Быстрая сходимость сети - за счет того, что каждое устройство знает о всех возможных путях до требуемой сети, возвращение топологии в рабочее состояние происходит быстрее, по сравнению с DVP.
## Минусы

1. Большая требовательность к мощностям устройства, за счет потребности просчитывать большое количество вариантов построения маршрута