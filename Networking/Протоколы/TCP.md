#Networking #Protocols
## TCP как протокол

TCP - протокол 4 уровня модели OSI (Транспортный). Является надежным протоколом передачи данных, т.к. устанавливает сессии и удостоверяется, что пакет был получен адресатом.

TCP медленнее, чем UDP за счет того, что при использовании TCP требуется подтверждение получения пакета, перед отправкой следующего. 
## Установление TCP-сессии

Установление сессии относится к процессу инициализации полей "Sequence" и "Acknowledgement" и согласования устанавливаемых портов. TCP сообщает об установлении соединения, используя 2 бита в полях флагов заголовка TCP (20 бит). Эти биты называются флагами SYN и ACK.
	SYN - "синхронизировать порядковые номера"
	ACK - "подтверждение"
Установление TCP-сессии происходит в 3 шага (рукопожатия)
1. Хост1 отправляет Хосту2 пакет с флагом SYN и два значения: DPORT (Destination port) и SPORT (Self port).
2. Хост2 получает пакет и отправляет Хосту1 пакет с флагами SYN и ACK и два значения: DPORT и SPORT. 
3. Хосты синхронизируются, договорившись о портах на первых двух шагах. Теперь Хост1 отправляет Хосту2 пакет с флагом ACK и двумя значениями: DPORT и SPORT, которые будут являться окончательными.

![[Графическое представление установления сессии TCP]]

## Отправка пакетов по TCP

При отправке данных по сессии TCP, хост-отправитель посылает пакет с одним сегментов (зачастую равным MSS канала).
В ответ, хост-получатель отправляет ACK с указанием своего размера окна (равному размеру всего его буфера - 1, т.к. первый слот буфера заполнен первым пакетом хоста-отправителя).
Хост-отправитель отправляет сразу 4 сегмента, они записываются в буфер хоста-получателя.
Хост-получатель отправляет очередной ACK, в котором указывается новый размер окна (Размер буфера - 5 сегментов, записанных ранее).
Хост-отправитель отправляет оставшиеся сегменты, равные размеру окна, полученному на прошлом шаге.
Хост-получатель отправляет новый ack с указанием остатка размера буфера, т.е. 0.
Отправитель понимает, что буфер забит и уходит в ожидание нового пакета.
Когда место в буфере освобождается, хост-получатель отправляет новый ACK с указанием размера окна. Повторить.

Логика состоит в том, что данные действия позволяют устройствам при общении между собой понимать, когда можно, а когда нельзя посылать пакеты, т.к. устройство с более быстрым packet-flow может "затопить" более медленное.

Хост-отправитель, если ждет слишком долго, может отправить пакет Zero Window Probe - пакет, направленный на проверку состояния окна буфера - проще говоря, убедиться, что хост-получатель еще на связи и не произошло ошибок (например, пакет с сегментом потерялся, или хост-получатель потерялся).
После получения этого пакета, хост-получатель отправляет один из двух пакетов:
	1. Подтвердить, что размер окна 0
	2. Прислать новый размер окна, тем самым разрешив дальнейшую отправку

![[Графическое представление отправки пакетов по TCP]]